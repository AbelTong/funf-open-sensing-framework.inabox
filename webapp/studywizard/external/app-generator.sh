# 
# Funf: Open Sensing Framework
# Copyright (C) 2010-2011 Nadav Aharony, Wei Pan, Alex Pentland.
# Acknowledgments: Alan Gardner
# Contact: nadav@media.mit.edu
#
# Author(s): Swetank Kumar Saha (swetank.saha@gmail.com)
# 
# This file is part of Funf.
# 
# Funf is free software: you can redistribute it and/or modify
# it under the terms of the GNU Lesser General Public License as
# published by the Free Software Foundation, either version 3 of
# the License, or (at your option) any later version.
# 
# Funf is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
# See the GNU Lesser General Public License for more details.
# 
# You should have received a copy of the GNU Lesser General Public
# License along with Funf. If not, see <http://www.gnu.org/licenses/>.
# 
#! /bin/bash
# Generates the andoird app and pushes it to dropbox

sudo apt-get -y install openjdk-6-jdk
sudo apt-get -y install ant
sudo dpkg --add-architecture i386
sudo apt-get update
sudo apt-get -y install libstdc++6:i386 libgcc1:i386 zlib1g:i386 libncurses5:i386
sudo apt-get -y install git
sudo apt-get -y install unzip

#Install Android SDK tools and components
cd $HOME
wget http://dl.google.com/android/android-sdk_r22.0.1-linux.tgz
tar xzvf android-sdk_r22.0.1-linux.tgz
echo "y" | ./android-sdk-linux/tools/android update sdk -u -f -t 1,2,3,7

#Install Python modules
cd $HOME
wget https://pypi.python.org/packages/source/s/setuptools/setuptools-0.9.6.tar.gz
tar xzvf setuptools-0.9.6.tar.gz
cd setuptools-0.9.6
sudo python setup.py install
cd $HOME
wget https://pypi.python.org/packages/source/p/pip/pip-1.3.1.tar.gz
tar xzvf pip-1.3.1.tar.gz
cd pip-1.3.1
sudo python setup.py install
cd $HOME
sudo pip install simplejson
sudo pip install dropbox

#Get Android app template and setup environment
cd $HOME
wget -O app_generator.tar.gz http://www.funf.org/app_generator.tar.gz
tar xzvf app_generator.tar.gz
cd app_generator
wget -O generate_app_remote.py http://metadata/computeMetadata/v1beta1/instance/attributes/generator-script
export DROPBOX_APP_KEY=$(curl http://metadata/computeMetadata/v1beta1/instance/attributes/DROPBOX_APP_KEY)
export DROPBOX_APP_SECRET=$(curl http://metadata/computeMetadata/v1beta1/instance/attributes/DROPBOX_APP_SECRET)
cd android_app_template
echo """# This file is automatically generated by Android Tools.
# Do not modify this file -- YOUR CHANGES WILL BE ERASED!
# 
# This file must *NOT* be checked in Version Control Systems,
# as it contains information specific to your local configuration.

# location of the SDK. This is only used by Ant
# For customization when using a Version Control System, please read the
# header note.
sdk.dir=$HOME/android-sdk-linux""" > local.properties
cd ..

#Build the App and Push to dropbox
python generate_app_remote.py

#Self-Terminate
sudo poweroff